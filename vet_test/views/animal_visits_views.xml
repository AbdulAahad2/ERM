<odoo>
  <!-- ===================== KANBAN VIEW ===================== -->
  <record id="view_vet_animal_visit_kanban" model="ir.ui.view">
    <field name="name">vet.animal.visit.kanban</field>
    <field name="model">vet.animal.visit</field>
    <field name="arch" type="xml">
      <kanban class="o_kanban_vet_dashboard">
        <field name="name"/>
        <field name="animal_id"/>
        <field name="animal_pic"/>
        <field name="animal_display_name"/>
        <field name="owner_id"/>
        <field name="doctor_id"/>
        <field name="date"/>
        <field name="state"/>
        <field name="total_amount"/>
        <field name="debug_animal_pic" readonly="1"/>

        <templates>
          <t t-name="card">
            <div class="o_kanban_card d-flex flex-column h-100">
              <div class="o_kanban_card_header d-flex justify-content-between align-items-start mb-2">
                <!-- Animal Image or Fallback Icon -->
                <div class="o_kanban_image me-2">
                  <t t-if="record.animal_pic.raw_value">
                    <field name="animal_pic" class="oe_avatar" widget="image" options="{'size': [80, 80]}"/>
                  </t>
                  <t t-else="">
                    <img src="/vet_test/static/src/img/logo.png" class="oe_avatar img-fluid rounded-circle" style="width:80px;height:80px;object-fit:cover;"/>
                  </t>
                </div>
                <!-- Main Info -->
                <div class="flex-fill">
                  <strong class="o_kanban_record_title">
                    <t t-esc="record.animal_id.display_name or record.animal_display_name.value"/>
                  </strong>
                  <div class="text-muted">
                    <t t-esc="record.owner_id.value"/>
                  </div>
                  <div>
                    <i class="fa fa-user-md me-1"></i> <t t-esc="record.doctor_id.value or '-'"/>
                  </div>
                  <div>
                    <i class="fa fa-calendar me-1"></i> <t t-esc="record.date.value"/>
                  </div>
                </div>
                <!-- Right-side info -->
                <div class="text-end">
                  <span t-attf-class="badge rounded-pill #{record.state.raw_value == 'done' and 'bg-success' or record.state.raw_value == 'draft' and 'bg-secondary' or 'bg-warning'}">
                    <t t-esc="record.state.value"/>
                  </span>
                  <div class="fw-bold mt-1 fs-5">
                    <t t-esc="record.total_amount.value or 0.00"/>
                  </div>
                </div>
              </div>
            </div>
          </t>
        </templates>
      </kanban>
    </field>
  </record>

  <!-- ===================== PAYMENT WIZARD ACTION ===================== -->
  <record id="view_vet_animal_visit_payment_wizard_form" model="ir.ui.view">
    <field name="name">vet.animal.visit.payment.wizard.form</field>
    <field name="model">vet.animal.visit.payment.wizard</field>
    <field name="arch" type="xml">
      <form string="Register Payment">
        <sheet>
          <group>
            <field name="visit_id" invisible="1"/>
            <field name="company_id" invisible="1"/>
            <field name="partner_id" invisible="1"/>
            <field name="current_invoice_id" invisible="1"/>
            <field name="other_unpaid_count" invisible="1"/>
          </group>
          
          <!-- Payment Mode Selection -->
          <group string="Payment Options">
            <field name="payment_mode" widget="radio" options="{'horizontal': true}"/>
          </group>
          
          <!-- Current Invoice Details -->
          <group string="Current Invoice Details" 
                 invisible="payment_mode != 'current'">
            <field name="current_invoice_id" readonly="1" string="Invoice"/>
            <field name="current_invoice_amount" 
                   readonly="1" 
                   string="Amount Due"
                   widget="monetary"/>
          </group>
          
          <!-- Other Invoices Selection -->
          <group string="Select Other Invoices to Pay" 
                 invisible="payment_mode != 'other'">
            <field name="other_invoice_ids" 
                   nolabel="1"
                   widget="many2many"
                   domain="[('partner_id', '=', partner_id), ('move_type', '=', 'out_invoice'), ('state', '=', 'posted'), ('payment_state', 'in', ['not_paid', 'partial']), ('id', '!=', current_invoice_id)]">
              <list>
                <field name="name" string="Invoice #"/>
                <field name="invoice_date"/>
                <field name="amount_total" string="Total"/>
                <field name="amount_residual" string="Due Amount"/>
                <field name="payment_state"/>
              </list>
            </field>
          </group>
          
          <!-- All Invoices Info -->
          <group string="All Unpaid Invoices" 
                 invisible="payment_mode != 'all'">
            <div class="alert alert-info" role="alert">
              <p>This will pay all unpaid invoices for this customer in chronological order.</p>
            </div>
            <field name="owner_unpaid_balance" 
                   readonly="1" 
                   string="Total Unpaid Balance"
                   widget="monetary"/>
          </group>
          
          <!-- Payment Details -->
          <group string="Payment Details">
            <field name="amount" 
                   string="Payment Amount"
                   widget="monetary"
                   readonly="payment_mode in ['current', 'all']"
                   force_save="1"/>
            <field name="journal_id" 
                   string="Payment Journal"
                   required="1"
                   domain="[('company_id', '=', company_id), ('type', 'in', ['cash', 'bank'])]"
                   options="{'no_create': True, 'no_open': True}"
                   placeholder="Select Cash or Bank journal..."/>
          </group>
          
          <!-- Summary Info Banner -->
          <div class="alert alert-warning" 
               role="alert"
               invisible="other_unpaid_count == 0 or payment_mode != 'current'">
            <strong>Note:</strong> This customer has <field name="other_unpaid_count" readonly="1"/> other unpaid invoice(s). 
            You can select "Pay Other Invoices" mode to pay them.
          </div>
        </sheet>
        
        <footer>
          <button string="Confirm Payment"
            type="object"
            name="action_confirm_payment"
            class="btn-primary"/>
          <button string="Cancel" special="cancel" class="btn-secondary"/>
        </footer>
      </form>
    </field>
  </record>

  <record id="action_vet_animal_visit_payment_wizard" model="ir.actions.act_window">
    <field name="name">Register Payment</field>
    <field name="res_model">vet.animal.visit.payment.wizard</field>
    <field name="view_mode">form</field>
    <field name="view_id" ref="view_vet_animal_visit_payment_wizard_form"/>
    <field name="target">new</field>
    <field name="context">{'default_visit_id': active_id}</field>
  </record>

  <!-- ===================== FORM VIEW ===================== -->
  <record id="view_vet_animal_visit_form" model="ir.ui.view">
      <field name="name">vet.animal.visit.form</field>
      <field name="model">vet.animal.visit</field>
      <field name="arch" type="xml">
          <form string="Animal Visit">
              <sheet>
                  <header>
                      <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,done,cancel"/>
                      <button name="action_create_invoice" string="Create Invoice" type="object" class="btn-primary"/>
                      <button name="action_pay_invoice" type="object" string="Pay Invoice"/>
                      <button name="action_print_visit_receipt" type="object" string="Print Receipt" class="btn-primary"/>
                  </header>

                  <!-- Title and Branch Info -->
                  <div class="oe_title mb-2">
                      <h2><field name="name" placeholder="Visit Number"/></h2>
                      <div class="o_row">
                          <label for="company_id" string="Branch:"/>
                          <field name="company_id" 
                                 options="{'no_create': True, 'no_open': True}" 
                                 readonly="1"
                                 class="oe_inline"/>
                      </div>
                  </div>

                  <!-- Main Two-Column Layout -->
                  <group>
                      <!-- LEFT COLUMN - Vertically Stacked Sections -->
                      <group>
                          <!-- Owner Information -->
                          <group string="Owner Information" class="oe_title" colspan="2">
                              <field name="owner_id" on_change="1"/>
                              <field name="contact_number" on_change="1"/>
                              <field name="animal_ids" widget="many2many_tags" string="Owner's Animals" domain="[('owner_id', '=', owner_id)]" readonly="1"/>
                              
                              <!-- Selected Animal ID -->
                              <field name="selected_animal_id" 
                                     string="Select Animal" 
                                     domain="[('id', 'in', animal_ids)]"
                                     required="1"
                                     options="{'no_open': True}"
                                     placeholder="Select an animal..."
                                     context="{
                                         'default_owner_id': owner_id,
                                         'default_contact_number': contact_number,
                                         'default_owner_name': owner_id and owner_id.name or 'New Owner'
                                     }"/>
                              
                              <field name="owner_unpaid_balance" readonly="1"/>
                          </group>

                          <!-- General Info -->
                          <group string="General Info" colspan="2">
                              <field name="animal_pic" widget="image" class="oe_avatar" options="{'size': [90, 90]}"/>
                              
                              <field name="animal_id" 
                                     string="Animal ID" 
                                     readonly="1"
                                     required="1"
                                     options="{'no_create': True, 'no_open': True}"/>
                              
                              <field name="animal_display_name" readonly="1"/>
                              <field name="date" readonly="1"/>
                              
                              <field name="doctor_id" 
                                     required="1"
                                     domain="[('company_id', '=', company_id)]"
                                     options="{'no_create': True}"
                                     context="{'default_company_id': company_id}"/>
                              
                              <field name="notes"/>
                              <field name="treatment_charge" string="Treatment Charge"/>
                          </group>
                      </group>

                      <!-- RIGHT COLUMN: Receipt + Totals -->
                      <group>
                          <!-- Receipt Section -->
                          <group string="Receipt" colspan="2">
                              <field name="receipt_lines" nolabel="1">
                                  <list editable="bottom">
                                      <field name="service_id" string="Item"/>
                                      <field name="quantity" string="Qty"/>
                                      <field name="original_price" string="List Price" readonly="1"/>
                                      <field name="line_discount" string="Disc %"/>
                                      <field name="price_unit" string="Final Price" readonly="1"/>
                                      <field name="subtotal" string="Subtotal" readonly="1"/>
                                  </list>
                              </field>
                          </group>

                          <!-- Totals Section - Full Width of Right Column -->
                          <group string="Totals" colspan="2">
                              <field name="subtotal" string="Sub Total" readonly="1" widget="monetary" currency_field="currency_id"/>
                              <field name="treatment_charge" string="Treatment Charges" readonly="1" widget="monetary" currency_field="currency_id"/>
                              <field name="discount_percent" string="Discount (%)" widget="monetary" currency_field="currency_id"/>
                              <field name="discount_fixed" string="Discount (Fixed)" widget="monetary" currency_field="currency_id"/>
                              <field name="total_amount" string="Total Amount" readonly="1" widget="monetary" class="oe_subtotal_footer_separator" currency_field="currency_id"/>
                          </group>
                      </group>
                  </group>

                  <!-- NOTEBOOK FOR SERVICES / TESTS / MEDICINES -->
                  <notebook>
                      <page string="Services">
                          <field name="service_line_ids">
                              <list editable="bottom">
                                  <field name="service_id" domain="[('service_type','=','service')]"/>
                                  <field name="quantity"/>
                                  <field name="original_price" string="List Price" readonly="1"/>
                                  <field name="line_discount" string="Disc %"/>
                                  <field name="price_unit" string="Final Price" readonly="1"/>
                                  <field name="subtotal" readonly="1"/>
                              </list>
                          </field>
                      </page>
                      <page string="Tests">
                          <field name="test_line_ids">
                              <list editable="bottom">
                                  <field name="service_id" string="Test" domain="[('service_type','=','test')]"/>
                                  <field name="quantity"/>
                                  <field name="original_price" string="List Price" readonly="1"/>
                                  <field name="line_discount" string="Disc %"/>
                                  <field name="price_unit" string="Final Price" readonly="1"/>
                                  <field name="subtotal" readonly="1"/>
                              </list>
                          </field>
                      </page>
                      <page string="Vaccines">
                          <field name="medicine_line_ids">
                              <list editable="bottom">
                                  <field name="service_id" string="Vaccine" domain="[('service_type','=','vaccine')]"/>
                                  <field name="quantity"/>
                                  <field name="original_price" string="List Price" readonly="1"/>
                                  <field name="line_discount" string="Disc %"/>
                                  <field name="price_unit" string="Final Price" readonly="1"/>
                                  <field name="subtotal" readonly="1"/>
                              </list>
                          </field>
                      </page>
                  </notebook>
              </sheet>
          </form>
      </field>
  </record>

  <!-- ===================== LIST VIEW ===================== -->
  <record id="view_vet_animal_visit_list" model="ir.ui.view">
    <field name="name">vet.animal.visit.list</field>
    <field name="model">vet.animal.visit</field>
    <field name="arch" type="xml">
      <list string="Animal Visits" create="true" delete="true">
        <field name="name"/>
        <field name="company_id" string="Branch" optional="show"/>
        <field name="date"/>
        <field name="animal_id" string="Animal ID"/>
        <field name="animal_display_name" string="Animal Name"/>
        <field name="owner_id"/>
        <field name="doctor_id"/>
        <field name="state"/>
        <field name="payment_state"/>
        <field name="total_amount"/>
      </list>
    </field>
  </record>

  <!-- ===================== SEARCH VIEW ===================== -->
  <record id="view_vet_animal_visit_search" model="ir.ui.view">
    <field name="name">vet.animal.visit.search</field>
    <field name="model">vet.animal.visit</field>
    <field name="arch" type="xml">
      <search>
        <field name="name"/>
        <field name="date"/>
        <field name="animal_id"/>
        <field name="owner_id"/>
        <field name="doctor_id"/>
        <field name="company_id" string="Branch"/>

        <!-- New filter for contact number -->
        <field name="contact_number" string="Contact Number" />

        <!-- Filters -->
        <filter name="my_branch" string="My Branch" 
                domain="[('company_id', '=', allowed_company_ids[0])]"
                help="Show only visits from my current branch"/>
        <filter name="all_branches" string="All Branches" 
                domain="[]"
                help="Show visits from all branches"/>
        <separator/>
        <filter name="unpaid_invoices" string="Unpaid" 
                domain="[('payment_state','=','not_paid')]"/>
        <filter name="paid_invoices" string="Paid" 
                domain="[('payment_state','=','paid')]"/>
        <separator/>
        <filter name="draft" string="Draft" 
                domain="[('state','=','draft')]"/>
        <filter name="confirmed" string="Confirmed" 
                domain="[('state','=','confirmed')]"/>
        <filter name="done" string="Done" 
                domain="[('state','=','done')]"/>
        
        <!-- Group By -->
        <group expand="0" string="Group By">
          <filter name="branch_group" string="Branch" 
                  context="{'group_by':'company_id'}"/>
          <filter name="owner_name" string="Owner" 
                  context="{'group_by':'owner_id'}"/>
          <filter name="doctor_name" string="Doctor" 
                  context="{'group_by':'doctor_id'}"/>
          <filter name="payment_state" string="Payment State" 
                  context="{'group_by':'payment_state'}"/>
          <filter name="state_group" string="State" 
                  context="{'group_by':'state'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- ===================== ACTION WINDOW ===================== -->
  <record id="action_vet_animal_visit" model="ir.actions.act_window">
    <field name="name">Animal Visits</field>
    <field name="res_model">vet.animal.visit</field>
    <field name="view_mode">kanban,list,form</field>
    <field name="search_view_id" ref="view_vet_animal_visit_search"/>
    <field name="domain">[('company_id', '=', allowed_company_ids[0])]</field>
    <field name="context">{
        'default_company_id': allowed_company_ids[0],
        'search_default_my_branch': 1
    }</field>
  </record>
</odoo>
